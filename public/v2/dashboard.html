<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>MM Courier ERP - Multi-Customer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  background: #c0c0c0;
  font-family: Tahoma, Arial, sans-serif;
  font-size: 12px;
  margin: 0;
  color: #000;
}
.toolbar {
  background: #d4d0c8;
  border-bottom: 2px solid #ffffff;
  padding: 4px;
  display: flex;
  gap: 4px;
}
.toolbar button {
  border: 2px outset #ffffff;
  background: #e0e0e0;
  padding: 3px 10px;
  cursor: pointer;
}
.toolbar button:active { border: 2px inset #ffffff; }
.toolbar .logout { margin-left: auto; background: #f2e5b8; }
#app { padding: 8px; }
.panel {
  background: #d4d0c8;
  border: 2px outset #ffffff;
  padding: 8px;
  margin-bottom: 8px;
}
.edit-container { display: flex; gap: 6px; }
.sidebar {
  width: 200px;
  background: #d4d0c8;
  border: 2px inset #ffffff;
}
.sidebar div {
  padding: 6px;
  border-bottom: 1px solid #b0b0b0;
  cursor: pointer;
}
.sidebar div:hover { background: #b0b0b0; }
.workspace {
  flex: 1;
  background: #ffffff;
  border: 2px inset #ffffff;
  padding: 10px;
}
.status { font-size: 11px; margin-top: 6px; }
select { margin-bottom: 6px; }
</style>
</head>

<body>

<div class="toolbar">
  <button onclick="loadPanel('edit')">Edit</button>
  <button onclick="loadPanel('process')">Process</button>
  <button onclick="loadPanel('view')">View</button>
  <button onclick="loadPanel('reports')">Reports</button>
  <button onclick="loadPanel('import')">Import</button>
  <button id="adminTab" onclick="loadPanel('admin')">Admin</button>
  <button onclick="loadPanel('analytics')">Analytics</button>
  <button class="logout" onclick="logout()">Logout</button>
</div>

<div id="app">
  <div class="panel">
    <h3>Welcome to MM Courier ERP</h3>
    <div class="status" id="tenantStatus">Loading tenant...</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, collection, addDoc, getDocs,
  serverTimestamp, query, where, limit, updateDoc
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

/* ===================== FIREBASE ===================== */
const firebaseConfig = {
  apiKey: "AIzaSyDVn4lqyV-I9Z1tQNKnrbHEZCvdNY1FDY4",
  authDomain: "mm-courier-software.firebaseapp.com",
  projectId: "mm-courier-software",
  storageBucket: "mm-courier-software.firebasestorage.app",
  messagingSenderId: "1088997998974",
  appId: "1:1088997998974:web:7d31deb10940ef2b4af32f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let CURRENT_USER = null;
let CUSTOMERS = [];
let ACTIVE_CUSTOMER = null;

/* ===================== CSV PARSER ===================== */
function parseCSV(text) {
  const [header, ...lines] = text.trim().split(/\r?\n/);
  const keys = header.split(",").map(h => h.trim().toLowerCase());

  return lines.map(line => {
    const values = line.split(",");
    const row = {};

    keys.forEach((k, i) => {
      row[k] = (values[i] || "").trim();
    });

    // normalize aliases
    return {
      waybill: row.waybill || "",
      trackingNumber: row.tracking || row.track || "",
      contents: row.contents || row.content || "",
      consignee: row.consignee || row.receiver || "",
    };
  });
}
  
/* ===================== CUSTOMER STATE ===================== */
async function loadCustomerState() {
  const snap = await getDocs(
    collection(db, "tenants", CURRENT_USER.tenantId, "customers")
  );
  CUSTOMERS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  ACTIVE_CUSTOMER = CUSTOMERS[0] || null;
}

/* ===================== CUSTOMER UI ===================== */
function populateCustomerSelect() {
  const sel = document.getElementById("customerSelect");
  if (!sel) return;

  sel.innerHTML = "";

  if (!CUSTOMERS.length) {
    sel.innerHTML = `<option>No customers</option>`;
    return;
  }

  CUSTOMERS.forEach(c => {
    sel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
  });

  sel.value = ACTIVE_CUSTOMER?.id || "";
  sel.onchange = () => {
    ACTIVE_CUSTOMER = CUSTOMERS.find(c => c.id === sel.value);
  };
}

function getCustomerId() {
  return document.getElementById("customerSelect")?.value || null;
}

/* ===================== AUTH ===================== */
onAuthStateChanged(auth, async (user) => {
  if (!user) return location.href = "login.html";

  const snap = await getDoc(doc(db, "users", user.uid));
  if (!snap.exists()) return alert("User profile not found");

  CURRENT_USER = snap.data();
  await loadCustomerState();

  document.getElementById("tenantStatus").innerText =
    `Tenant: ${CURRENT_USER.tenantId} | Role: ${CURRENT_USER.role}`;

  if (CURRENT_USER.role !== "admin") {
    document.getElementById("adminTab").style.display = "none";
  }
});

/* ===================== SAFETY ===================== */
function ensureUserReady() {
  if (!CURRENT_USER?.tenantId) {
    alert("User still loading");
    return false;
  }
  return true;
}

/* ===================== EDIT ===================== */
window.loadEdit = async (type) => {
  if (!ensureUserReady()) return;

  const ws = document.getElementById("workspace");
  ws.innerHTML = `
    <label>Select Customer:</label>
    <select id="customerSelect" onchange="loadEdit('waybills')"></select><br>
    <h3>Waybills</h3>
    <table border="1" width="100%">
      <tr><th>Waybill</th><th>Consignee</th><th>Status</th><th>Last Scan</th></tr>
      <tbody id="wbRows"></tbody>
    </table>
  `;
  populateCustomerSelect();

  const customerId = getCustomerId();
  const rows = document.getElementById("wbRows");

  if (!customerId) {
    rows.innerHTML = `<tr><td colspan="4">No customer selected</td></tr>`;
    return;
  }

  const snap = await getDocs(
    collection(db, "tenants", CURRENT_USER.tenantId, "customers", customerId, "waybills")
  );

  if (snap.empty) {
    rows.innerHTML = `<tr><td colspan="4">No waybills</td></tr>`;
    return;
  }

  for (const d of snap.docs) {
    const w = d.data();
    rows.innerHTML += `
      <tr>
        <td>${w.waybill || "â€”"}</td>
        <td>${w.Receiver || "â€”"}</td>
        <td>${w.status || "Imported"}</td>
        <td>â€”</td>
      </tr>`;
  }
};

/* ===================== PROCESS ===================== */
window.loadProcess = async (type) => {
  if (!ensureUserReady()) return;

  const ws = document.getElementById("workspace");
  ws.innerHTML = `
    <label>Select Customer:</label>
    <select id="customerSelect"></select><br>
    <h3>Scan ${type.toUpperCase()}</h3>
    <input id="scanWB" autofocus>
    <div class="status" id="scanStatus"></div>
  `;
  populateCustomerSelect();

  const input = document.getElementById("scanWB");
  const status = document.getElementById("scanStatus");

  input.onkeydown = async (e) => {
    if (e.key !== "Enter") return;

    const waybill = input.value.trim();
    const customerId = getCustomerId();
    if (!waybill || !customerId) return;

    await addDoc(
      collection(db, "tenants", CURRENT_USER.tenantId, "customers", customerId, "scans"),
      { waybill, type: type.toUpperCase(), createdAt: serverTimestamp() }
    );

    status.innerText = `Scanned ${waybill}`;
    input.value = "";
  };
};

/* ===================== VIEW ===================== */
window.loadView = async () => {
  if (!ensureUserReady()) return;

  document.getElementById("app").innerHTML = `
    <div class="panel">
      <label>Select Customer:</label>
      <select id="customerSelect"></select>
      <div class="workspace" id="workspace"></div>
    </div>
  `;
  populateCustomerSelect();
};

/* ===================== IMPORT ===================== */
window.loadImport = () => {
  if (!ensureUserReady()) return;

  document.getElementById("app").innerHTML = `
    <div class="panel">
      <label for="customerSelect">Select Customer:</label>
      <select id="customerSelect"></select><br><br>

      <label for="wbFile">Import Waybills (CSV):</label><br>
      <input type="file" id="wbFile" accept=".csv"><br><br>

      <button onclick="runImport()">Import</button>
      <div class="status" id="importStatus"></div>
    </div>
  `;

  populateCustomerSelect();
};

 window.runImport = async () => {
  const file = document.getElementById("wbFile")?.files[0];
  const status = document.getElementById("importStatus");
  const customerId = getCustomerId();

  if (!file) {
    status.innerText = "Please select a CSV file";
    return;
  }

  if (!customerId) {
    status.innerText = "Please select a customer";
    return;
  }

  const rows = parseCSV(await file.text());
  let success = 0;
  let failed = 0;

  for (const r of rows) {
    if (!r.waybill) {
      failed++;
      continue;
    }

    // ðŸ” Detect target collection
    let target = "waybills";

    if (r.item || r.description || r.qty) {
      target = "contents";
    }

    if (r.status || r.location || r.event || r.scan) {
      target = "tracking";
    }

    try {
      await addDoc(
        collection(
          db,
          "tenants",
          CURRENT_USER.tenantId,
          "customers",
          customerId,
          target
        ),
        {
          ...r,
          waybill: r.waybill,
          source: "import",
          createdAt: serverTimestamp()
        }
      );

      success++;
    } catch (e) {
      console.error(e);
      failed++;
    }
  }

  status.innerText = `Import complete: ${success} imported, ${failed} skipped`;
};
  
/* ===================== PANEL ===================== */
window.loadPanel = (panel) => {
  if (!ensureUserReady()) return;

  const app = document.getElementById("app");

  if (panel === "edit") {
    app.innerHTML = `
      <div class="panel">
        <div class="edit-container">
          <div class="sidebar">
            <div onclick="loadEdit('waybills')">Waybills</div>
          </div>
          <div class="workspace" id="workspace"></div>
        </div>
      </div>`;
  }

  if (panel === "process") {
    app.innerHTML = `
      <div class="panel">
        <div class="edit-container">
          <div class="sidebar">
            <div onclick="loadProcess('in')">Scan IN</div>
            <div onclick="loadProcess('out')">Scan OUT</div>
          </div>
          <div class="workspace" id="workspace"></div>
        </div>
      </div>`;
  }

  if (panel === "view") {
    loadView();
  }

  if (panel === "import") {
    loadImport();
  }
};


/* ===================== LOGOUT ===================== */
window.logout = async () => {
  await signOut(auth);
  location.href = "login.html";
};
</script>
</body>
</html>
