<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>MM Courier ERP - Multi-Customer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  background: #c0c0c0;
  font-family: Tahoma, Arial, sans-serif;
  font-size: 12px;
  margin: 0;
  color: #000;
}
.toolbar {
  background: #d4d0c8;
  border-bottom: 2px solid #ffffff;
  padding: 4px;
  display: flex;
  gap: 4px;
}
.toolbar button {
  border: 2px outset #ffffff;
  background: #e0e0e0;
  padding: 3px 10px;
  cursor: pointer;
}
.toolbar button:active { border: 2px inset #ffffff; }
.toolbar .logout { margin-left: auto; background: #f2e5b8; }
#app { padding: 8px; }
.panel {
  background: #d4d0c8;
  border: 2px outset #ffffff;
  padding: 8px;
}
.edit-container { display: flex; gap: 6px; }
.sidebar {
  width: 200px;
  background: #d4d0c8;
  border: 2px inset #ffffff;
}
.sidebar div {
  padding: 6px;
  border-bottom: 1px solid #b0b0b0;
  cursor: pointer;
}
.sidebar div:hover { background: #b0b0b0; }
.workspace {
  flex: 1;
  background: #ffffff;
  border: 2px inset #ffffff;
  padding: 10px;
}
.status { font-size: 11px; margin-top: 6px; }
select { margin-bottom: 6px; }
</style>
</head>

<body>

<div class="toolbar">
  <button onclick="loadPanel('edit')">Edit</button>
  <button onclick="loadPanel('process')">Process</button>
  <button onclick="loadPanel('import')">Import</button>
  <button class="logout" onclick="logout()">Logout</button>
</div>

<div id="app">
  <div class="panel">
    <h3>Welcome to MM Courier ERP</h3>
    <div class="status" id="tenantStatus">Loading...</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, collection, addDoc, getDocs,
  serverTimestamp, query, where, limit
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDVn4lqyV-I9Z1tQNKnrbHEZCvdNY1FDY4",
  authDomain: "mm-courier-software.firebaseapp.com",
  projectId: "mm-courier-software",
  storageBucket: "mm-courier-software.firebasestorage.app",
  messagingSenderId: "1088997998974",
  appId: "1:1088997998974:web:7d31deb10940ef2b4af32f"
};

const appFB = initializeApp(firebaseConfig);
const auth = getAuth(appFB);
const db = getFirestore(appFB);

let CURRENT_USER = null;
let CUSTOMERS = [];
let ACTIVE_CUSTOMER = null;

/* ================= AUTH ================= */
onAuthStateChanged(auth, async (user) => {
  if (!user) return location.href = "login.html";

  const snap = await getDoc(doc(db, "users", user.uid));
  CURRENT_USER = snap.data();

  await loadCustomers();

  document.getElementById("tenantStatus").innerText =
    `Tenant: ${CURRENT_USER.tenantId} | Role: ${CURRENT_USER.role}`;
});

/* ================= HELPERS ================= */
function ensureUserReady() {
  return CURRENT_USER?.tenantId;
}

async function loadCustomers() {
  const snap = await getDocs(
    collection(db, "tenants", CURRENT_USER.tenantId, "customers")
  );
  CUSTOMERS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  ACTIVE_CUSTOMER = CUSTOMERS[0] || null;
}

function populateCustomerSelect() {
  const sel = document.getElementById("customerSelect");
  if (!sel) return;

  sel.innerHTML = "";

  CUSTOMERS.forEach(c => {
    sel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
  });

  if (ACTIVE_CUSTOMER) sel.value = ACTIVE_CUSTOMER.id;

  sel.onchange = () => {
    ACTIVE_CUSTOMER = CUSTOMERS.find(c => c.id === sel.value);
    refreshWaybills();
  };
}

function getCustomerId() {
  return document.getElementById("customerSelect")?.value;
}

<!-- ===================== EDIT ===================== -->
<script>
window.loadEdit = async () => {
  if (!ensureUserReady()) return;

  const ws = document.getElementById("workspace");
  ws.innerHTML = `
    <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px;">
      <label>Select Customer:</label>
      <select id="customerSelect"></select>
      <button id="refreshBtn" title="Refresh waybills">ðŸ”„</button>
    </div>

    <h3>Waybills</h3>
    <table border="1" width="100%">
      <thead>
        <tr>
          <th>Waybill</th>
          <th>Consignee</th>
          <th>Status</th>
          <th>Last Scan</th>
        </tr>
      </thead>
      <tbody id="wbRows">
        <tr><td colspan="4">Loading...</td></tr>
      </tbody>
    </table>
  `;

  populateCustomerSelect();

  // attach refresh click AFTER html exists
  document.getElementById("refreshBtn").onclick = refreshWaybills;

  // initial load
  await refreshWaybills();
};

/* ===================== REFRESH WAYBILLS ===================== */
window.refreshWaybills = async () => {
  const customerId = document.getElementById("customerSelect")?.value;
  const rows = document.getElementById("wbRows");

  if (!customerId) {
    rows.innerHTML = `<tr><td colspan="4">No customer selected</td></tr>`;
    return;
  }

  // clear before reload
  rows.innerHTML = `<tr><td colspan="4">Refreshing...</td></tr>`;

  const snap = await getDocs(
    collection(
      db,
      "tenants",
      CURRENT_USER.tenantId,
      "customers",
      customerId,
      "waybills"
    )
  );

  rows.innerHTML = "";

  if (snap.empty) {
    rows.innerHTML = `<tr><td colspan="4">No waybills</td></tr>`;
    return;
  }

  snap.forEach(docSnap => {
    const w = docSnap.data();

    // safety guard
    if (!w.waybill) return;

    rows.innerHTML += `
      <tr>
        <td>
          <a href="#" onclick="openWaybill('${customerId}', '${w.waybill}')">
            ${w.waybill}
          </a>
        </td>
        <td>${w.Receiver || "â€”"}</td>
        <td>${w.status || "Imported"}</td>
        <td>â€”</td>
      </tr>
    `;
  });
};
</script>

/* ================= PROCESS ================= */
window.loadProcess = async (type) => {
  document.getElementById("app").innerHTML = `
    <div class="panel">
      <label>Customer:</label>
      <select id="customerSelect"></select><br>
      <input id="scanWB" placeholder="Scan waybill">
      <div class="status" id="scanStatus"></div>
    </div>
  `;

  populateCustomerSelect();

  document.getElementById("scanWB").onkeydown = async (e) => {
    if (e.key !== "Enter") return;

    await addDoc(
      collection(
        db,
        "tenants",
        CURRENT_USER.tenantId,
        "customers",
        getCustomerId(),
        "scans"
      ),
      { waybill: e.target.value, createdAt: serverTimestamp() }
    );

    document.getElementById("scanStatus").innerText = "Scanned";
    e.target.value = "";
  };
};

/* ================= IMPORT ================= */
window.loadImport = () => {
  document.getElementById("app").innerHTML = `
    <div class="panel">
      <h3>Import</h3>
      <select id="customerSelect"></select><br>
      <input type="file"><br>
      <button>Import</button>
    </div>
  `;
  populateCustomerSelect();
};

/* ================= LOGOUT ================= */
window.logout = async () => {
  await signOut(auth);
  location.href = "login.html";
};
</script>
</body>
</html>
