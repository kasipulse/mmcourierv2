<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MM Courier Dashboard</title>
<style>
  body { font-family: "Tahoma","Segoe UI",sans-serif; background:#c0c0c0; margin:0; }
  .toolbar { background:#d4d0c8; padding:4px; display:flex; gap:6px; }
  .menu-btn { background:#e0e0e0; border:2px outset #fff; padding:2px 10px; cursor:pointer; }
  .menu-btn:active { border:2px inset #fff; background:#d0d0d0; }
  #content-panel { padding:12px; }
  input { border:2px inset #fff; margin:4px 0; padding:3px; }
  button { padding:4px 8px; border:2px outset #fff; cursor:pointer; }
</style>
</head>
<body>

<div class="toolbar">
  <button class="menu-btn" onclick="logout()">Logout</button>
</div>

<div id="content-panel">
  <h1>Welcome to MM Courier Dashboard</h1>
  <p>Upload CSVs for your tenant below:</p>

  <label>Waybill CSV:</label>
  <input type="file" id="waybillFile" accept=".csv"><br>
  <label>Content CSV:</label>
  <input type="file" id="contentFile" accept=".csv"><br>
  <label>Tracking CSV:</label>
  <input type="file" id="trackFile" accept=".csv"><br>
  <button id="processBtn">Import CSVs</button>
  <div id="importStatus" style="margin-top:10px;"></div>
</div>

<script type="module">
import { db, auth, serverTime } from "./js/firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { collection, addDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import Papa from "https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js";

const processBtn = document.getElementById("processBtn");
const statusDiv = document.getElementById("importStatus");
let tenantId = null;

function cleanRow(row) {
  const cleaned = {};
  for (let k in row) cleaned[k] = row[k] !== undefined ? row[k] : null;
  return cleaned;
}

async function importCSV(file, collectionName) {
  return new Promise((resolve, reject) => {
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: async results => {
        let inserted = 0;
        for (let row of results.data) {
          try {
            await addDoc(collection(db, collectionName), { ...cleanRow(row), tenantId, createdAt: serverTime() });
            inserted++;
          } catch(e) {
            console.error("Failed row:", row, e.message);
          }
        }
        resolve(inserted);
      },
      error: err => reject(err)
    });
  });
}

// Enable button only when tenant loaded
onAuthStateChanged(auth, async user => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  // Fetch tenantId from Firestore users collection
  const userDoc = await db.collection("users").doc(user.uid).get(); // adjust if using modules
  if (!userDoc.exists) {
    statusDiv.innerHTML = `<span style="color:red;">❌ Tenant not found</span>`;
    return;
  }
  tenantId = userDoc.data().tenantId;
  processBtn.disabled = false;
  statusDiv.innerHTML = `<span style="color:green;">✅ Tenant loaded: ${tenantId}</span>`;
});

processBtn.addEventListener("click", async () => {
  const waybillFile = document.getElementById("waybillFile").files[0];
  const contentFile = document.getElementById("contentFile").files[0];
  const trackFile = document.getElementById("trackFile").files[0];

  if (!waybillFile || !contentFile || !trackFile) {
    statusDiv.innerHTML = `<span style="color:red;">⚠️ Select all three CSV files</span>`;
    return;
  }

  statusDiv.innerHTML = `⏳ Importing...`;

  try {
    const insertedWaybills = await importCSV(waybillFile, "waybills");
    const insertedContents = await importCSV(contentFile, "contents");
    const insertedTracking = await importCSV(trackFile, "tracking");

    statusDiv.innerHTML = `<span style="color:green;">✅ Waybills: ${insertedWaybills}, Contents: ${insertedContents}, Tracking: ${insertedTracking}</span>`;
  } catch(err) {
    statusDiv.innerHTML = `<span style="color:red;">❌ Import failed: ${err.message}</span>`;
  }
});

function logout() {
  auth.signOut();
  window.location.href = "login.html";
}
</script>

<!-- Include PapaParse for CSV parsing -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

</body>
</html>
