<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MM Courier | Import CSV</title>
<style>
  body { font-family: Tahoma, sans-serif; background:#c0c0c0; color:#000; padding:20px; }
  .panel { background:#d4d0c8; border:2px outset #fff; padding:20px; max-width:500px; margin:auto; }
  label { display:block; margin-top:12px; font-weight:bold; }
  input[type="file"] { margin-top:4px; }
  button { margin-top:12px; padding:10px; font-size:14px; cursor:pointer; border:2px outset #fff; background:#e0e0e0; }
  button:active { border:2px inset #fff; background:#d0d0d0; }
  #importStatus { margin-top:12px; }
</style>
</head>
<body>

<div class="panel">
  <h2>Import CSV Files</h2>

  <label for="waybillFile">Waybill CSV:</label>
  <input type="file" id="waybillFile" accept=".csv">

  <label for="contentFile">Content CSV:</label>
  <input type="file" id="contentFile" accept=".csv">

  <label for="trackFile">Tracking CSV:</label>
  <input type="file" id="trackFile" accept=".csv">

  <button id="processBtn" disabled>Upload & Process CSVs</button>

  <div id="importStatus"></div>
</div>

<script type="module">
import { db } from "./firebase.js";
import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import Papa from "https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js";

const auth = getAuth();
const processBtn = document.getElementById("processBtn");
const statusDiv = document.getElementById("importStatus");

let tenantId = null;

// Wait for tenantId from logged-in user
onAuthStateChanged(auth, async user => {
  if (!user) return window.location.href="index.html";

  const userDoc = await db.collection("users").doc(user.uid).get();
  if (!userDoc.exists) {
    statusDiv.innerHTML = `<span style="color:red;">❌ Tenant not found for this user</span>`;
    return;
  }

  tenantId = userDoc.data().tenantId;
  processBtn.disabled = false;
});

// Helper to parse CSV to JSON
function parseCSV(file) {
  return new Promise((resolve, reject) => {
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: results => resolve(results.data),
      error: err => reject(err)
    });
  });
}

processBtn.addEventListener("click", async () => {
  if (!tenantId) {
    statusDiv.innerHTML = `<span style="color:red;">❌ Cannot import: tenantId unknown</span>`;
    return;
  }

  const waybillFile = document.getElementById("waybillFile").files[0];
  const contentFile = document.getElementById("contentFile").files[0];
  const trackFile = document.getElementById("trackFile").files[0];

  if (!waybillFile || !contentFile || !trackFile) {
    statusDiv.innerHTML = `<span style="color:red;">⚠️ Please select all three CSV files.</span>`;
    return;
  }

  statusDiv.innerHTML = `⏳ Processing CSVs...`;

  try {
    const [waybills, contents, tracks] = await Promise.all([
      parseCSV(waybillFile),
      parseCSV(contentFile),
      parseCSV(trackFile)
    ]);

    // Insert waybills
    for (let row of waybills) {
      await addDoc(collection(db, "waybills"), { ...row, tenantId, createdAt: serverTimestamp() });
    }

    // Insert contents
    for (let row of contents) {
      await addDoc(collection(db, "contents"), { ...row, tenantId, createdAt: serverTimestamp() });
    }

    // Insert tracks
    for (let row of tracks) {
      await addDoc(collection(db, "tracking"), { ...row, tenantId, createdAt: serverTimestamp() });
    }

    statusDiv.innerHTML = `<span style="color:green;">✅ Imported successfully!</span>`;
  } catch (err) {
    console.error(err);
    statusDiv.innerHTML = `<span style="color:red;">❌ Import failed: ${err.message}</span>`;
  }
});
</script>

<!-- Load PapaParse for CSV parsing -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

</body>
</html>
