<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Import Data | MM Courier</title>
<style>
  body { font-family: "Tahoma","Segoe UI",sans-serif; background:#c0c0c0; padding:20px; }
  .panel { background:#d4d0c8; border:2px outset #fff; padding:12px; box-shadow: inset 1px 1px #fff; }
  input, button { margin:5px 0; padding:5px; font-size:13px; }
  button { cursor:pointer; border:2px outset #fff; background:#e0e0e0; }
  button:active { border:2px inset #fff; background:#d0d0d0; }
  #importStatus { margin-top:10px; font-size:12px; }
</style>
</head>
<body>

<div class="panel">
  <h2>Import CSV Files</h2>
  <input type="file" id="contentFile" accept=".csv"><br>
  <input type="file" id="waybillFile" accept=".csv"><br>
  <input type="file" id="trackFile" accept=".csv"><br>
  <button id="processBtn">Upload and Import</button>
  <div id="importStatus"></div>
</div>

<script type="module">
import { auth, db } from "/v2/js/firebase.js";
import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { getDoc, doc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

const processBtn = document.getElementById("processBtn");
const statusDiv = document.getElementById("importStatus");

let tenantId;

onAuthStateChanged(auth, async user => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }
  // get tenantId for this user
  const userSnap = await getDoc(doc(db, "users", user.uid));
  if (userSnap.exists()) tenantId = userSnap.data().tenantId;
  else statusDiv.innerText = "Tenant not found!";
});

function parseCSV(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const lines = reader.result.split("\n").map(line => line.trim()).filter(Boolean);
      const headers = lines[0].split(",");
      const data = lines.slice(1).map(l => {
        const row = {};
        l.split(",").forEach((v,i) => row[headers[i]] = v);
        return row;
      });
      resolve(data);
    };
    reader.onerror = () => reject(reader.error);
    reader.readAsText(file);
  });
}

processBtn.addEventListener("click", async () => {
  const contentFile = document.getElementById("contentFile").files[0];
  const waybillFile = document.getElementById("waybillFile").files[0];
  const trackFile = document.getElementById("trackFile").files[0];

  if (!contentFile || !waybillFile || !trackFile) {
    statusDiv.innerHTML = `<span style="color:red;">⚠️ Please select all three CSV files.</span>`;
    return;
  }

  statusDiv.innerHTML = `⏳ Importing CSVs...`;

  try {
    const [contents, waybills, tracks] = await Promise.all([
      parseCSV(contentFile),
      parseCSV(waybillFile),
      parseCSV(trackFile)
    ]);

    // Add tenantId and timestamp to each
    await Promise.all([
      ...waybills.map(row => addDoc(collection(db,"waybills"), {...row, tenantId, createdAt: serverTimestamp()})),
      ...contents.map(row => addDoc(collection(db,"contents"), {...row, tenantId, createdAt: serverTimestamp()})),
      ...tracks.map(row => addDoc(collection(db,"tracking"), {...row, tenantId, createdAt: serverTimestamp()}))
    ]);

    statusDiv.innerHTML = `<span style="color:green;">✅ Imported successfully!</span>`;
  } catch(err) {
    statusDiv.innerHTML = `<span style="color:red;">❌ Import failed: ${err.message}</span>`;
  }
});
</script>

</body>
</html>
