<!doctype html>
<html>
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Invoices — MM Courier</title>
<style>
  body{font-family:Tahoma,Arial;background:#c0c0c0;margin:0;color:#000;font-size:13px}
  .toolbar{background:#d4d0c8;padding:6px}
  .container{padding:12px}
  .panel{background:#d4d0c8;border:2px outset #fff;padding:12px;margin-bottom:12px}
  label{display:block;margin-top:6px}
  input,select,button{padding:8px;border:2px inset #fff;background:#fff;width:100%;box-sizing:border-box}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #999;padding:6px;text-align:left;font-size:13px}
  th{background:#e0e0e0}
  .actions{display:flex;gap:8px;margin-top:8px}
</style>
</head>
<body>
  <div class="toolbar"><strong>Invoices</strong></div>
  <div class="container">
    <div class="panel">
      <label>Company</label>
      <select id="companySelect"></select>
      <label>Customer</label>
      <select id="customerSelect"></select>
      <label>Date from</label><input id="dateFrom" type="date"/>
      <label>Date to</label><input id="dateTo" type="date"/>
      <div class="actions">
        <button id="previewBtn" style="background:#e0e0e0;border:2px outset #fff;padding:8px">Preview</button>
        <button id="generateBtn" style="background:#deb657;border:2px outset #fff;padding:8px">Generate Invoice</button>
      </div>
    </div>

    <div id="previewPanel" class="panel" style="display:none">
      <h3>Preview</h3>
      <div id="previewMeta" class="muted"></div>
      <table id="previewTable"><thead><tr>
        <th>Waybill</th><th>Date</th><th>Recipient</th><th>Origin</th><th>Destination</th><th>Basic</th><th>Fuel</th><th>Other</th><th>Subtotal</th>
      </tr></thead><tbody></tbody></table>
      <div style="margin-top:10px"><strong>Totals:</strong> <span id="totals"></span></div>
      <div style="margin-top:10px"><button id="printBtn">Print Invoice</button></div>
    </div>
  </div>

<script>
async function loadCompanies(){
  const res = await fetch('/api/companies'); const list = await res.json();
  const sel = document.getElementById('companySelect'); sel.innerHTML='';
  list.forEach(c=> sel.appendChild(Object.assign(document.createElement('option'), {value:c.id, textContent:c.name})));
  sel.addEventListener('change', loadCustomers);
  if(list[0]) sel.value=list[0].id, loadCustomers();
}
async function loadCustomers(){
  const companyId=document.getElementById('companySelect').value;
  const res = await fetch('/api/customers?companyId='+companyId); const customers = await res.json();
  const sel = document.getElementById('customerSelect'); sel.innerHTML='';
  customers.forEach(c=> sel.appendChild(Object.assign(document.createElement('option'), {value:c.id, textContent:c.name})));
}

document.getElementById('previewBtn').addEventListener('click', async ()=>{
  const cust = document.getElementById('customerSelect').value;
  const from = document.getElementById('dateFrom').value;
  const to = document.getElementById('dateTo').value;
  const res = await fetch(`/api/invoice/preview?customerId=${cust}&from=${from}&to=${to}`);
  const data = await res.json();
  // data.items = array of parcel lines; data.totals
  const tbody = document.querySelector('#previewTable tbody'); tbody.innerHTML='';
  data.items.forEach(it=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${it.waybill_number}</td><td>${it.date}</td><td>${it.recipient}</td><td>${it.origin}</td><td>${it.destination}</td><td>${it.basic}</td><td>${it.fuel}</td><td>${it.other}</td><td>${it.subtotal}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('totals').textContent = `Subtotal: R${data.totals.subtotal} • VAT: R${data.totals.vat} • Total: R${data.totals.total}`;
  document.getElementById('previewMeta').textContent = `Waybills: ${data.items.length} • Range: ${from} → ${to}`;
  document.getElementById('previewPanel').style.display='block';
});

document.getElementById('generateBtn').addEventListener('click', async ()=>{
  const cust = document.getElementById('customerSelect').value;
  const from = document.getElementById('dateFrom').value;
  const to = document.getElementById('dateTo').value;
  const res = await fetch('/api/invoice/generate', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({customerId:cust, from, to})});
  if(res.ok){ alert('Invoice generated'); } else { alert('invoice failed'); }
});

document.getElementById('printBtn').addEventListener('click', ()=> window.print());

loadCompanies();
</script>
</body>
</html>
