<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>View Waybills | MM Courier</title>
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body class="flex bg-gray-100 min-h-screen">

  <!-- Sidebar -->
  <aside class="w-64 bg-[#0a2b52] text-white flex flex-col">
    <div class="p-4 border-b border-gray-700">
      <h2 class="text-xl font-bold">MM Courier</h2>
      <p class="text-xs">ERP Platform</p>
    </div>

    <nav class="flex-1 p-4 space-y-2">
      <a href="dashboard.html" class="block py-2 px-3 rounded hover:bg-[#409dbc]">Dashboard</a>
      <a href="import.html" class="block py-2 px-3 rounded hover:bg-[#409dbc]">Import Data</a>
      <a href="tripsheets.html" class="block py-2 px-3 rounded hover:bg-[#409dbc]">Tripsheets</a>
      <a href="view-waybills.html" class="block py-2 px-3 rounded bg-[#409dbc]">View Waybills</a>
      <a href="reports.html" class="block py-2 px-3 rounded hover:bg-[#409dbc]">Reports</a>
    </nav>

    <div class="p-4 border-t border-gray-700">
      <button id="logout" class="bg-[#cebd80] w-full py-2 text-[#0a2b52] rounded-md font-medium">
        Logout
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-8">
    <h1 class="text-3xl font-semibold text-[#0a2b52] mb-4">View Imported Waybills</h1>

    <!-- Filters -->
    <div class="bg-white p-4 rounded-2xl shadow mb-4 flex flex-wrap gap-4 items-end">
      <div>
        <label class="block text-[#0a2b52] font-medium mb-1">Date From</label>
        <input type="date" id="dateFrom" class="border p-2 rounded-md">
      </div>
      <div>
        <label class="block text-[#0a2b52] font-medium mb-1">Date To</label>
        <input type="date" id="dateTo" class="border p-2 rounded-md">
      </div>
      <div>
        <label class="block text-[#0a2b52] font-medium mb-1">Customer</label>
        <input type="text" id="customerFilter" placeholder="Customer name" class="border p-2 rounded-md">
      </div>
      <div>
        <label class="block text-[#0a2b52] font-medium mb-1">Status</label>
        <select id="statusFilter" class="border p-2 rounded-md">
          <option value="">All</option>
          <option value="Delivered">Delivered</option>
          <option value="In Transit">In Transit</option>
          <option value="Pending">Pending</option>
          <option value="Returned">Returned</option>
        </select>
      </div>
      <div class="flex gap-2">
        <button id="filterBtn" class="bg-[#409dbc] text-white px-4 py-2 rounded-md">Apply Filters</button>
        <button id="resetBtn" class="bg-gray-300 px-4 py-2 rounded-md">Reset</button>
      </div>
    </div>

    <!-- Search and Export -->
    <div class="flex justify-between items-center mb-4">
      <input type="text" id="searchBox" placeholder="Search by tracking or recipient..." class="border p-2 rounded-md w-1/3">
      <div class="space-x-2">
        <button id="exportCSV" class="bg-[#cebd80] px-4 py-2 rounded-md text-[#0a2b52] font-medium">Export CSV</button>
        <button id="exportPDF" class="bg-[#0a2b52] px-4 py-2 rounded-md text-white font-medium">Export PDF</button>
      </div>
    </div>

    <!-- Table -->
    <div class="bg-white p-4 rounded-2xl shadow overflow-x-auto">
      <table id="waybillTable" class="min-w-full text-sm text-left">
        <thead class="bg-[#0a2b52] text-white">
          <tr>
            <th class="py-2 px-3">Tracking #</th>
            <th class="py-2 px-3">Sender</th>
            <th class="py-2 px-3">Recipient</th>
            <th class="py-2 px-3">Address</th>
            <th class="py-2 px-3">Customer</th>
            <th class="py-2 px-3">Status</th>
            <th class="py-2 px-3">Imported</th>
          </tr>
        </thead>
        <tbody id="waybillBody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </main>

  <script>
    const supabaseUrl = "https://lavqgvnjdjfywcjztame.supabase.co";
    const supabaseKey = "YOUR_PUBLIC_ANON_KEY";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    async function checkSession() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) window.location.href = "login.html";
    }
    checkSession();

    document.getElementById("logout").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    });

    let allWaybills = [];

    async function loadWaybills() {
      const { data, error } = await supabase
        .from("parcels")
        .select("*")
        .order("imported_at", { ascending: false });
      if (error) {
        alert("Error loading waybills: " + error.message);
        return;
      }
      allWaybills = data;
      renderTable(data);
    }

    function renderTable(rows) {
      const tbody = document.getElementById("waybillBody");
      tbody.innerHTML = "";
      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="py-2 px-3">${r.tracking_number || ""}</td>
          <td class="py-2 px-3">${r.sender || ""}</td>
          <td class="py-2 px-3">${r.receiver || ""}</td>
          <td class="py-2 px-3">${r.address || ""}</td>
          <td class="py-2 px-3">${r.customer || ""}</td>
          <td class="py-2 px-3">${r.status || ""}</td>
          <td class="py-2 px-3">${r.imported_at ? new Date(r.imported_at).toLocaleString() : ""}</td>
        `;
        tbody.appendChild(tr);
