<div class="panel">
  <h2>Import Parcels</h2>
  <p>Select the three CSV files sent by your 3PL vendors and press "Process Import".</p>

  <form id="importForm" onsubmit="return false;" style="margin-top: 10px;">
    <label>Content CSV:</label><br />
    <input type="file" id="contentFile" name="content" accept=".csv" required /><br /><br />

    <label>Waybill CSV:</label><br />
    <input type="file" id="waybillFile" name="waybill" accept=".csv" required /><br /><br />

    <label>Track CSV:</label><br />
    <input type="file" id="trackFile" name="track" accept=".csv" required /><br /><br />

    <button type="button" id="processBtn" class="menu-btn">Process Import</button>
  </form>

  <div id="importStatus" style="margin-top: 10px;"></div>
</div>

<script>
function initImportForm() {
  const statusDiv = document.getElementById("importStatus");
  const processBtn = document.getElementById("processBtn");

  processBtn.addEventListener("click", async () => {
    const contentFile = document.getElementById("contentFile").files[0];
    const waybillFile = document.getElementById("waybillFile").files[0];
    const trackFile = document.getElementById("trackFile").files[0];

    if (!contentFile || !waybillFile || !trackFile) {
      statusDiv.innerHTML = `<div style="color:red;">⚠️ Please select all three CSV files before processing.</div>`;
      return;
    }

    const formData = new FormData();
    formData.append("content", contentFile);
    formData.append("waybill", waybillFile);
    formData.append("track", trackFile);

    statusDiv.innerHTML = `<div>⏳ Uploading and processing files...</div>`;

    try {
      // ✅ Correct endpoint
      const res = await fetch("/api/import/upload", {
        method: "POST",
        body: formData,
      });

      if (!res.ok) {
        const text = await res.text(); // show server error
        throw new Error(text);
      }

      const data = await res.json();

      statusDiv.innerHTML = `<div style="color:green;">✅ Import successful! ${data.inserted || 0} parcels inserted.</div>`;
    } catch (err) {
      statusDiv.innerHTML = `<div style="color:red;">❌ Import failed: ${err.message}</div>`;
    }
  });
}
</script>
