<div class="panel">
  <h2>Import Parcels</h2>
  <p>Select the three CSV files and click "Process Import".</p>

  <form id="importForm" onsubmit="return false;">
    <label>Content CSV:</label><br />
    <input type="file" id="contentFile" name="content" accept=".csv" required /><br /><br />

    <label>Waybill CSV:</label><br />
    <input type="file" id="waybillFile" name="waybill" accept=".csv" required /><br /><br />

    <label>Track CSV:</label><br />
    <input type="file" id="trackFile" name="track" accept=".csv" required /><br /><br />

    <button type="button" id="processBtn" class="menu-btn">Process Import</button>
  </form>

  <div id="importStatus" style="margin-top: 10px;"></div>
  <div id="waybillTable" style="margin-top: 15px;"></div>
</div>

<script>
function initImportForm() {
  const btn = document.getElementById("processBtn");
  const statusDiv = document.getElementById("importStatus");
  const tableDiv = document.getElementById("waybillTable");

  btn.onclick = async () => {
    const content = document.getElementById("contentFile").files[0];
    const waybill = document.getElementById("waybillFile").files[0];
    const track = document.getElementById("trackFile").files[0];

    if (!content || !waybill || !track) {
      statusDiv.innerHTML = `<span style="color:red;">⚠️ Select all three files</span>`;
      return;
    }

    const form = new FormData();
    form.append("content", content);
    form.append("waybill", waybill);
    form.append("track", track);

    // YOUR REAL IDs HERE
    form.append("company_id", "1");
    form.append("customer_id", "1");
    form.append("user_id", "1");

    statusDiv.innerHTML = `⏳ Processing...`;
    tableDiv.innerHTML = "";

    try {
      const response = await fetch("/api/import/upload", {
        method: "POST",
        body: form,
      });

      const data = await response.json();

      if (!response.ok) {
        statusDiv.innerHTML = `<span style="color:red;">❌ Import failed: ${data.error}</span>`;
        return;
      }

      statusDiv.innerHTML = `<span style="color:green;">✅ Imported ${data.inserted} parcels</span>`;

      if (!data.insertedData) return;

      // Build result table
      let html = `
        <table border="1" width="100%" style="border-collapse: collapse;">
        <tr>
          <th>Waybill</th>
        </tr>
      `;

      data.insertedData.forEach((p) => {
        html += `
          <tr>
            <td>${p.waybill_number}</td>
          </tr>
        `;
      });

      html += `</table>`;
      tableDiv.innerHTML = html;

    } catch (err) {
      statusDiv.innerHTML = `<span style="color:red;">❌ Import crashed: ${err.message}</span>`;
    }
  };
}

document.addEventListener("DOMContentLoaded", initImportForm);
</script>
