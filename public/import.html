<div class="panel">
  <h2>Import Parcels</h2>
  <p>Select the three CSV files sent by your 3PL vendors and press "Process Import".</p>

  <form id="importForm" onsubmit="return false;" style="margin-top: 10px;">
    <label>Content CSV:</label><br />
    <input type="file" id="contentFile" name="content" accept=".csv" required /><br /><br />

    <label>Waybill CSV:</label><br />
    <input type="file" id="waybillFile" name="waybill" accept=".csv" required /><br /><br />

    <label>Track CSV:</label><br />
    <input type="file" id="trackFile" name="track" accept=".csv" required /><br /><br />

    <button type="button" id="processBtn" class="menu-btn">Process Import</button>
  </form>

  <div id="importStatus" style="margin-top: 10px;"></div>
  <div id="waybillTable" style="margin-top: 15px;"></div>
</div>

<script>
function initImportForm() {
  const processBtn = document.getElementById("processBtn");
  const statusDiv = document.getElementById("importStatus");
  const waybillDiv = document.getElementById("waybillTable");

  processBtn.addEventListener("click", async () => {
    const contentFile = document.getElementById("contentFile").files[0];
    const waybillFile = document.getElementById("waybillFile").files[0];
    const trackFile = document.getElementById("trackFile").files[0];

    if (!contentFile || !waybillFile || !trackFile) {
      statusDiv.innerHTML = `<div style="color:red;">⚠️ Please select all three CSV files.</div>`;
      return;
    }

    const formData = new FormData();
    formData.append("content", contentFile);
    formData.append("waybill", waybillFile);
    formData.append("track", trackFile);

    statusDiv.innerHTML = `<div>⏳ Uploading and processing CSVs...</div>`;
    waybillDiv.innerHTML = "";

    try {
      const res = await fetch("/api/import/upload", {  // <-- correct endpoint
        method: "POST",
        body: formData
      });

      if (!res.ok) throw new Error(`Server returned ${res.status}`);
      const data = await res.json();

      if (data.success) {
        statusDiv.innerHTML = `<div style="color:green;">✅ Successfully imported ${data.inserted} parcels!</div>`;

        // Show inserted waybills in table
        const table = document.createElement("table");
        table.style.width = "100%";
        table.style.borderCollapse = "collapse";
        table.innerHTML = `
          <tr style="background:#b0b0b0;">
            <th style="border:1px solid #000; padding:4px;">Waybill</th>
            <th style="border:1px solid #000; padding:4px;">Sender</th>
            <th style="border:1px solid #000; padding:4px;">Receiver</th>
            <th style="border:1px solid #000; padding:4px;">Pieces</th>
            <th style="border:1px solid #000; padding:4px;">Act Mass</th>
          </tr>
        `;
        data.insertedData = data.insertedData || []; // optional if backend returns full inserted parcels
        data.insertedData.forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td style="border:1px solid #000; padding:4px;">${p.waybill}</td>
            <td style="border:1px solid #000; padding:4px;">${p.sender}</td>
            <td style="border:1px solid #000; padding:4px;">${p.receiver}</td>
            <td style="border:1px solid #000; padding:4px;">${p.pieces}</td>
            <td style="border:1px solid #000; padding:4px;">${p.actmass}</td>
          `;
          table.appendChild(tr);
        });
        waybillDiv.appendChild(table);
      } else {
        statusDiv.innerHTML = `<div style="color:red;">❌ Import failed: ${data.error || 'Unknown error'}</div>`;
      }

    } catch (err) {
      statusDiv.innerHTML = `<div style="color:red;">❌ Import failed: ${err.message}</div>`;
    }
  });
}
</script>
