<!doctype html>
<html><head><meta charset="utf-8"/><title>Tripsheet</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>body{font-family:system-ui;margin:20px}input{margin:4px}</style>
</head><body>
<h1>Driver Tripsheet</h1>
<div id="collections"></div>
<script>
const user = JSON.parse(localStorage.getItem('mm_user')||'null');
if(!user || user.role!=='driver') location.href='/driver-login.html';

async function loadCollections(){
  const res = await fetch(`/api/collections/driver/${user.id}`);
  const js = await res.json();
  const el = document.getElementById('collections');
  if(!js.collections || js.collections.length===0){ el.innerHTML='<p>No collections assigned.</p>'; return; }
  el.innerHTML = js.collections.map(c=>`
    <div style="border:1px solid #ddd;padding:8px;margin:8px 0">
      <strong>${c.temp_collection_no || ''}</strong> - ${c.client || c.requestor} - ${c.address || ''}<br/>
      <form data-id="${c.id}" style="display:flex;gap:8px;align-items:center">
        <input name="waybill" placeholder="Enter waybill" style="padding:6px"/>
        <input name="photo" type="file" />
        <button>Induct</button>
      </form>
    </div>
  `).join('');
}
document.addEventListener('submit', async e=>{
  if(e.target.matches('form[data-id]')){
    e.preventDefault();
    const id = e.target.dataset.id;
    const waybill = e.target.waybill.value;
    const file = e.target.photo.files[0];
    const form = new FormData();
    form.append('waybill_no', waybill);
    form.append('driver_id', user.id);
    if(file) form.append('photo', file);
    const res = await fetch(`/api/collections/induct/${id}`, { method:'POST', body: form });
    if(res.ok) { alert('Inducted'); loadCollections(); }
    else { const txt = await res.text(); alert('Error: '+txt); }
  }
});
loadCollections();
</script>
</body></html>
